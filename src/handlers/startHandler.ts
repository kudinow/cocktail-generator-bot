import TelegramBot from 'node-telegram-bot-api';
import StorageService from '../services/storageService';

export const sendStart = async (bot: TelegramBot, chatId: number, userId: number, storage: StorageService, username?: string) => {
  console.log(`[START] userId=${userId} chatId=${chatId} username=${username}`);

  // –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç –≤ –±–∞–∑–µ
  if (!storage.getUser(userId)) {
    storage.createUser(userId, username);
  }

  const welcomeMessage = `
üç∏ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Cocktail Bot!*

–Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø–æ–¥–æ–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–µ –∫–æ–∫—Ç–µ–π–ª–∏ –¥–ª—è –≤–µ—á–µ—Ä–∏–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ—é—â–∏—Ö—Å—è —É –≤–∞—Å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.

*–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:*
1Ô∏è‚É£ –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É –≤–∞—Å –µ—Å—Ç—å
2Ô∏è‚É£ –ù–∞–π–¥–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–æ–∫—Ç–µ–π–ª–∏
3Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å! üéâ

*–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/add\\_ingredient ‚Äî –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
/my\\_ingredients ‚Äî –ú–æ–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
/find\\_cocktails ‚Äî –ù–∞–π—Ç–∏ –∫–æ–∫—Ç–µ–π–ª–∏ –ø–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º
/clear ‚Äî –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
/help ‚Äî –°–ø—Ä–∞–≤–∫–∞
üîé –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–∫—Ç–µ–π–ª—è
üçπ –ü–æ–∏—Å–∫ –∫–æ–∫—Ç–µ–π–ª—è –ø–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—É

–ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /add\\_ingredient –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤! üëá
  `.trim();

  const keyboard = {
    inline_keyboard: [
      [{ text: '‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç', callback_data: 'add_ingredient' }],
      [{ text: 'üìã –ú–æ–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', callback_data: 'my_ingredients' }],
      [{ text: 'üîç –ù–∞–π—Ç–∏ –∫–æ–∫—Ç–µ–π–ª–∏', callback_data: 'find_cocktails' }],
      [{ text: 'üîé –ù–∞–π—Ç–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é', callback_data: 'search_by_name' }],
      [{ text: 'üçπ –ü–æ–∏—Å–∫ –ø–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—É', callback_data: 'search_by_ingredient' }]
    ]
  };

  await bot.sendMessage(chatId, welcomeMessage, {
    parse_mode: 'Markdown',
    reply_markup: keyboard
  });
};

export const handleStart = (bot: TelegramBot, storage: StorageService) => {
  bot.onText(/\/start/, async (msg) => {
    const chatId = msg.chat.id;
    const userId = msg.from?.id;
    if (!userId) return;
    await sendStart(bot, chatId, userId, storage, msg.from?.username);
  });

  bot.onText(/\/help/, async (msg) => {
    const chatId = msg.chat.id;

    const helpMessage = `
üìñ *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º*

*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/add\\_ingredient - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –≤ —Å–ø–∏—Å–æ–∫
/my\\_ingredients - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
/find\\_cocktails - –ù–∞–π—Ç–∏ –∫–æ–∫—Ç–µ–π–ª–∏ –ø–æ –≤–∞—à–∏–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º
/clear - –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

*–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:*
1. –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ–º–∞
2. –ë–æ—Ç –Ω–∞–π–¥–µ—Ç –≤—Å–µ –∫–æ–∫—Ç–µ–π–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å
3. –ö–æ–∫—Ç–µ–π–ª–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
4. –í—ã —É–≤–∏–¥–∏—Ç–µ, –∫–∞–∫–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–∫—Ç–µ–π–ª—è

*–°–æ–≤–µ—Ç—ã:*
‚Ä¢ –í—ã–±–∏—Ä–∞–π—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–æ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
‚Ä¢ –ß–µ–º –±–æ–ª—å—à–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤, —Ç–µ–º –±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∫–æ–∫—Ç–µ–π–ª–µ–π!

–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! üçπ
    `.trim();

    await bot.sendMessage(chatId, helpMessage, {
      parse_mode: 'Markdown'
    });
  });
};
